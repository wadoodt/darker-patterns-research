# Dark Pattern Validator Project

This project is a Next.js application designed to validate and research dark patterns in user interfaces, particularly those generated by Large Language Models (LLMs). It includes a public-facing survey for data collection, an informational website, and an admin dashboard for managing entries and viewing statistics.

## Table of Contents

1.  [Prerequisites](#prerequisites)
2.  [Getting Started](#getting-started)
    - [Cloning the Repository](#cloning-the-repository)
    - [Firebase Setup](#firebase-setup)
    - [Environment Variables](#environment-variables)
    - [Installing Dependencies](#installing-dependencies)
3.  [Running the Application](#running-the-application)
    - [Development Mode](#development-mode)
    - [Building for Production](#building-for-production)
    - [Starting the Production Server](#starting-the-production-server)
4.  [Key Technologies](#key-technologies)
5.  [Project Structure](#project-structure)
6.  [Firebase Integration](#firebase-integration)
    - [Authentication](#authentication)
    - [Firestore Database](#firestore-database)
    - [Firebase Functions](#firebase-functions)
    - [Firebase Storage](#firebase-storage)
    - [Firebase Hosting/App Hosting](#firebase-hostingapp-hosting)
7.  [Admin Dashboard Access](#admin-dashboard-access)
8.  [Deployment](#deployment)
9.  [Frequently Asked Questions (FAQs)](#frequently-asked-questions-faqs)
10. [Contributing](#contributing)

## Prerequisites

Before you begin, ensure you have the following installed:

- **Node.js:** Version 18.x or later (includes npm). Download from [nodejs.org](https://nodejs.org/).
- **Firebase CLI:** Install globally using `npm install -g firebase-tools`. See [Firebase CLI Setup Guide](./docs/firebase-cli-setup-deploy.md).
- **Git:** For cloning the repository.

## Getting Started

### Cloning the Repository

```bash
git clone <repository-url>
cd <repository-directory-name>
```

### Firebase Setup

1.  **Create a Firebase Project:** Go to the [Firebase Console](https://console.firebase.google.com/) and create a new project or use an existing one.
2.  **Add a Web App:** In your Firebase project, add a new Web App. Copy the Firebase configuration object provided.
3.  **Enable Firebase Services:**
    - **Authentication:** Enable Email/Password sign-in method.
    - **Firestore Database:** Create a Firestore database. Start in **test mode** for initial development (remember to secure your rules before production).
    - **Firebase Storage:** Enable Firebase Storage.
    - **Firebase Functions:** Ensure your project is on the Blaze (pay-as-you-go) plan to use Firebase Functions.
4.  **Initialize Firebase in your project:**
    ```bash
    firebase login # If not already logged in
    firebase init
    ```
    Select Firestore, Functions, Hosting (or App Hosting if preferred), and Storage. Link it to your Firebase project. For Functions, choose TypeScript.

### Environment Variables

Create a `.env.local` file in the root of your project and add your Firebase Web App configuration:

```env
NEXT_PUBLIC_FIREBASE_API_KEY=your_api_key
NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=your_auth_domain
NEXT_PUBLIC_FIREBASE_PROJECT_ID=your_project_id
NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=your_storage_bucket
NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=your_messaging_sender_id
NEXT_PUBLIC_FIREBASE_APP_ID=your_app_id
NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID=your_measurement_id
```

Replace `your_...` with the values from your Firebase project settings.

### Installing Dependencies

```bash
npm install
```

## Running the Application

### Development Mode

To run the Next.js application in development mode:

```bash
npm run dev
```

This will typically start the server on `http://localhost:9002` (or the port specified in `package.json`).

**Genkit AI Flows (Optional - if using Genkit locally):**
If you are developing Genkit AI flows locally, you might need to run the Genkit development server in a separate terminal:

```bash
npm run genkit:dev
# or for watch mode
npm run genkit:watch
```

### Building for Production

To create an optimized production build:

```bash
npm run build
```

### Starting the Production Server

After building, you can start the production server:

```bash
npm run start
```

## Key Technologies

- **Next.js (App Router):** React framework for server-side rendering and static site generation.
- **TypeScript:** Superset of JavaScript for type safety.
- **Tailwind CSS:** Utility-first CSS framework.
- **ShadCN UI:** Re-usable UI components built with Radix UI and Tailwind CSS.
- **Firebase:** Backend platform for authentication, database, functions, storage, and hosting.
  - **Firestore:** NoSQL database for storing DPO entries, evaluations, user data, etc.
  - **Firebase Authentication:** For user sign-up and login.
  - **Firebase Functions:** For backend logic like data aggregation and exports.
  - **Firebase Storage:** For storing exported data files.
- **Genkit (by Firebase):** For integrating Generative AI functionalities (if applicable).
- **Recharts / ShadCN Charts:** For data visualization in the admin dashboard.
- **Zod:** For schema validation.
- **React Hook Form:** For form handling.

## Project Structure

- **`src/app/`**: Contains all routes, pages, and layouts using the Next.js App Router.
  - **`src/app/(admin)/`**: Admin dashboard routes and components.
  - **`src/app/(info)/`**: Static informational pages.
  - **`src/app/(survey)/`**: Survey participation flow.
  - **`src/app/layout.tsx`**: Root layout for the application.
  - **`src/app/page.tsx`**: Landing page.
- **`src/components/`**: Shared UI components, organized by feature area (admin, common, info, landing, survey, ui).
- **`src/contexts/`**: React context providers (e.g., `AuthContext`, `SurveyProgressContext`).
- **`src/hooks/`**: Custom React hooks.
- **`src/lib/`**: Utility functions, Firebase initialization (`firebase.ts`), font definitions.
- **`src/styles/`**: Global CSS, Tailwind base styles, and component-specific CSS.
- **`src/types/`**: TypeScript type definitions.
- **`src/ai/`**: Genkit related files (if Genkit is used).
- **`functions/`**: Firebase Cloud Functions (TypeScript).
- **`docs/`**: Project documentation files.

## Firebase Integration

### Authentication

User authentication is handled by Firebase Authentication, primarily email/password and potentially social providers later. Custom claims (`admin`, `researcher`) are used to manage access levels.

### Firestore Database

Firestore is used to store:

- `dpo_entries`: The core dataset entries being evaluated.
- `evaluations`: Human evaluations submitted by survey participants.
- `survey_participants`: Information about survey participants (demographics, email if provided).
- `users`: Admin/researcher user profiles.
- `cached_statistics`: Aggregated data for faster dashboard loading (populated by Firebase Functions).
- `admin_settings`: Global settings for the project.
- `activity_log`: Logs of key activities on the platform.

### Firebase Functions

Located in the `functions/` directory, these are used for:

- Aggregating statistics from `evaluations` and `survey_participants` into `cached_statistics`.
- Creating activity logs.
- Handling data exports (generating CSV/JSON files and providing download links).
- See [Firebase Functions Integration Guide](./docs/firebase-functions-integration.md).

### Firebase Storage

Used to store files generated by data export functions.

### Firebase Hosting/App Hosting

The Next.js application is intended to be deployed using Firebase Hosting or Firebase App Hosting (recommended for Next.js dynamic features).

## Admin Dashboard Access

Access to the admin dashboard (`/admin/*`) is restricted to authenticated users with `researcher` or `admin` custom claims.

- **Signup:** New users can sign up via the `/signup` page.
- **Login:** Existing users can log in via the `/login` page (or `/admin/login`).
- **Setting Admin Claims:** To grant admin privileges (e.g., for data export), custom claims must be set using the Firebase Admin SDK. See [Setting Admin Custom Claims Guide](./docs/firebase-set-admin-claims.md).

## Deployment

Refer to the [Firebase CLI Setup and Deployment Guide](./docs/firebase-cli-setup-deploy.md) for detailed instructions on deploying your application and Firebase Functions.

## Frequently Asked Questions (FAQs)

- **Q: I'm getting Firebase errors like "Missing or insufficient permissions" or "API key not valid."**

  - **A1: Check Environment Variables:** Ensure your `.env.local` file has the correct Firebase Web App configuration keys from your Firebase project settings and that they are prefixed with `NEXT_PUBLIC_`.
  - **A2: Firebase Project Setup:** Verify that you have created a Web App in your Firebase project and that the services you're trying to use (Authentication, Firestore, Storage, Functions) are enabled in the Firebase Console.
  - **A3: Firestore Rules:** For Firestore, ensure your security rules allow read/write access as needed, especially during development. Default test mode rules are permissive, but production rules should be secure.
  - **A4: API Key Restrictions:** If you have restricted your API key in the Google Cloud Console, ensure it allows access from `localhost` (for development) and your deployed app's domain.

- **Q: My Firebase Functions are not deploying or are showing errors in the logs.**

  - **A1: Blaze Plan:** Firebase Functions (outside the free tier/emulation) require your Firebase project to be on the Blaze (pay-as-you-go) plan.
  - **A2: Node.js Version:** Ensure the Node.js version specified in your `functions/package.json` (e.g., `"engines": { "node": "18" }`) is compatible with your function code and supported by Firebase.
  - **A3: Dependencies:** Make sure all dependencies in `functions/package.json` are installed correctly (`npm install` inside the `functions` directory).
  - **A4: Code Errors:** Check the Firebase Functions logs in the Firebase Console for detailed error messages from your TypeScript/JavaScript code.
  - **A5: IAM Permissions:** The service account used by functions (usually `[PROJECT_ID]@appspot.gserviceaccount.com`) needs appropriate IAM roles to access other Firebase services (e.g., "Firebase Admin SDK Administrator Service Agent" or more granular permissions like "Cloud Datastore User" for Firestore).

- **Q: How do I run Firebase Functions locally for testing?**

  - **A:** Use the Firebase Emulator Suite: `firebase emulators:start`. You'll need to initialize it first with `firebase init emulators` and select Functions, Firestore, Auth, etc. Your application can then be configured to connect to these local emulators.

- **Q: Data in `cached_statistics` is not updating.**

  - **A:** Ensure the Firebase Functions responsible for aggregation (e.g., `onNewEvaluationUpdateStats`) are deployed and do not have errors in their logs. Verify the triggers are set up correctly for the relevant Firestore collections/documents.

- **Q: Admin exports are failing with "permission-denied."**

  - **A:** The `exportData` Firebase Function checks for an `admin: true` custom claim on the authenticated user. Ensure the admin user you are testing with has this claim set. Refer to the [Setting Admin Custom Claims Guide](./docs/firebase-set-admin-claims.md).

- **Q: My Tailwind CSS styles are not applying correctly or are missing.**
  - **A1: `globals.css`:** Ensure `@import "tailwindcss";` and `@theme { ... }` (for Tailwind v4) are correctly set up in `src/app/globals.css`.
  - **A2: `tailwind.config.ts`:** Verify the `content` array correctly points to all files that use Tailwind classes (e.g., `./src/components/**/*.{js,ts,jsx,tsx,mdx}`, `./src/app/**/*.{js,ts,jsx,tsx,mdx}`).
  - **A3: Restart Dev Server:** After significant Tailwind config changes, restarting the Next.js development server is often necessary.

## Contributing
